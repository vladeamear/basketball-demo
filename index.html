<!DOCTYPE html>
<html>
	<head>
		<title>Basketglock Game</title>
		<link rel="stylesheet" href="style.css">
		<script src="https://aframe.io/releases/1.1.0/aframe.min.js"></script>
		<script src="ar-components.js"></script>
		<!-- <script src="helpers.js"></script> -->
		<script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
	</head>
	<body class="inline">
		<a-scene webxr="optionalFeatures: hit-test, dom-overlay; overlayElement:#overlay;" physics="debug: false">
			<a-assets>
				<a-asset-item
					id="dictofon-model"
					src="./assets/dictofon.gltf"
				></a-asset-item>
				<a-asset-item
					id="glock-model"
					src="./assets/glock.gltf"
				></a-asset-item>
			</a-assets>
			<a-entity
				gltf-model="#dictofon-model"
				id="dictofon"
				dynamic-body
				scale="0.05 0.05 0.05" 
				position="0.1 2.36 -1.5"
			></a-entity>
			<a-entity
				id="box"
				geometry="primitive: cylinder"
				static-body
				scale="0.09 0.02 0.09"
				rotation="-90 0 0"
				material="color: red"
				hide-in-ar-mode
			></a-entity>

			<a-entity ar-hit-test="doHitTest:false" visible="false">
				<a-plane
					rotation="-90 0 0"
					width="0.2"
					height="0.2"
					src="./arrow.png"
					material="transparent:true;"
				></a-plane>
			</a-entity>
			<a-camera>
				<a-entity
					id="text"
					position="0 0 -0.17;"
					visible="false"
				>
				</a-entity>
			</a-camera>
		</a-scene>
		<div id="overlay" class="container">
			<div id="ar-instructions">
				<h1 id="in-ar-title">Welcome To Glockdictofon 1</h1>
				<section class="overlay-content">
					<p id="instructions">Place the Glock along a wall</p>
				</section>
				<div style="display: flex; justify-content: space-between; align-self: stretch;">
					<button id="go-button">Ready to Play!</button>
					<button id="exit-button">Stop AR</button>
				</div>
			</div>
			<div id="inline-instructions">
				<h1>Welcome To Glockdictofon 2</h1>
				<section class="overlay-content">
					<p>Enter AR to Start Playing</p>
				</section>
			</div>
		</div>
		<script>
			const reticle = document.querySelector("[ar-hit-test]");
			const instructions = document.getElementById('instructions');
			const inArTitle = document.getElementById('in-ar-title');
			const dictofon = document.getElementById('dictofon');
			const button = document.getElementById('go-button');
			const exit = document.getElementById('exit-button');
			const upVector = new THREE.Vector3(0, 1, 0);
			const tempVector = new THREE.Vector3();
			const tempQuaternion = new THREE.Quaternion();
			const scene = document.querySelector('a-scene');
			function getRandomInt(max) {
				return Math.floor(Math.random() * max);
			}

			const possibleEnemies = document.querySelectorAll('[geometry]');
			let currentEnemy = possibleEnemies[0];


			function hasDomOverlay(session) {
				if (!session.domOverlayState) {
					// DOM Overlay is not supported
					return false;
				}

				if (!session.domOverlayState.type) {
					// DOM Overlay is not in use
					return false;
				}

				return true;
			}

			function positionEnemy() {
				currentEnemy.setAttribute("position", reticle.getAttribute("position"));
				currentEnemy.setAttribute("visible", true);
				// glockHitBox.setAttribute("position", reticle.getAttribute("position"));
				// glockHitBox.setAttribute("visible", true);
				tempVector.set(0, 0 ,-1);
				tempVector.applyQuaternion(reticle.object3D.quaternion);
				tempQuaternion.setFromUnitVectors(tempVector, upVector);
				currentEnemy.object3D.quaternion.multiplyQuaternions(tempQuaternion, reticle.object3D.quaternion);
				// glockHitBox.object3D.quaternion.multiplyQuaternions(tempQuaternion, reticle.object3D.quaternion);
			};

			// let nOfCollisions = 0;

			currentEnemy.addEventListener('collide', (e) => {
				// const n = nOfCollisions++;
				// const [x, y] = [getRandomInt(10), getRandomInt(10)]
				// inArTitle.innerText = `${JSON.stringify(currentEnemy.getAttribute("position"))}`;
				// currentEnemy.object3D.position.set(x,y,0);
				// currentEnemy.parentNode.removeChild(currentEnemy);
				currentEnemy.setAttribute('material', 'color: green')
				// currentEnemy = possibleEnemies[1];
				// inArTitle.innerText = `${x} ${y} Entity collided`;
			})

			exit.addEventListener('click', function () {
				scene.xrSession.end();
			});

			scene.addEventListener("enter-vr", () => {
				const domOverlay = hasDomOverlay(scene.xrSession);
				document.getElementById('text').setAttribute('text', 'value', 'Overlay: ' + domOverlay);
				document.body.classList.remove("inline");
				if (scene.is("ar-mode")) {
					document.body.classList.add("ar-preparing");
					reticle.setAttribute('ar-hit-test', 'doHitTest:true');
					reticle.setAttribute('visible', 'true');
				} else {
					document.body.classList.add("playing");
					reticle.setAttribute('ar-hit-test', 'doHitTest:false');
					reticle.setAttribute('visible', 'false');
				}
			});

			scene.addEventListener("exit-vr", () => {
				document.body.classList.add("inline");
				document.body.classList.remove("playing");
				document.body.classList.remove("ar-preparing");
				reticle.setAttribute('ar-hit-test', 'doHitTest:false');
				reticle.setAttribute('visible', 'false');
			});

			reticle.addEventListener('select', function (e) {
				const domOverlay = hasDomOverlay(scene.xrSession);
				if (document.body.classList.contains("playing")) {
					const pose = e.detail.pose;
					dictofon.body.position.copy(pose.transform.position);
					// dictofon.body.position.y += 0.2;
					tempVector.set(0, 0 ,-5);
					tempVector.applyQuaternion(pose.transform.orientation);
					dictofon.body.velocity.copy(tempVector);
					return;
				}

				if (domOverlay) {
					setTimeout(() => {
						if (document.body.classList.contains("playing")) {
							return;
						} else {
							positionEnemy();
						}
					}, 50);
				} else {
					if (document.body.classList.contains("playing")) {
						return;
					} else {
						if (this.components["ar-hit-test"].hasFoundAPose) {
							positionEnemy();
							readyToStartPlay(e);
						}
					}
				}
			});

			function readyToStartPlay(e) {
				e.preventDefault();
				if (currentEnemy.getAttribute("visible") === false) {
					positionEnemy();
				}
				if (document.body.classList.contains("ar-preparing")) {
					document.body.classList.remove("ar-preparing");
					document.body.classList.add("playing");
					reticle.setAttribute('ar-hit-test', 'doHitTest:false');
					reticle.setAttribute('visible', 'false');
					return;
				}
			}

			button.addEventListener('mousedown', readyToStartPlay);
			button.addEventListener('touchstart', readyToStartPlay);
		</script>
	</body>
</html>
